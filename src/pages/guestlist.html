<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>é è¨€å®¶æ—¥å ± - éœæ ¼è¯èŒ²è³“å®¢åå†Š</title>
<link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
<link as="style" href="https://fonts.googleapis.com/css2?display=swap&amp;family=Newsreader%3Awght%40400%3B500%3B700%3B800&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900" onload="this.rel='stylesheet'" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<link href="data:image/x-icon;base64," rel="icon" type="image/x-icon"/>
<script src="../../config/config.js"></script>
<link rel="stylesheet" href="../../assets/css/harry-potter.css">
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<style type="text/tailwindcss">
        :root {
            --primary-color: #1791cf;
            --secondary-color: #f0f3f4;
            --text-color: #111518;
            --background-color: #f3e9d8;
            --accent-color: #e0f7fa;
            --subtle-border: #e0e0e0;
            --checked-in-bg: #e8f5e9;
            --unchecked-bg: #ffffff;
            --checked-in-text: #2e7d32;
            --unchecked-text: #111518;
        }
        body {
            font-family: 'Newsreader', 'Noto Sans', sans-serif;
        }
        /* é­”æ³•è¤‡é¸æ¡†æ¨£å¼å·²ç§»è‡³ harry-potter.css */
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-primary:hover {
            background-color: #147ab3;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .magic-wand-icon {
            font-family: 'Material Symbols Outlined';
            font-weight: normal;
            font-style: normal;
            font-size: 20px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-feature-settings: 'liga';
            -webkit-font-smoothing: antialiased;
        }
        .table-header {
             color: #ffffff;
             font-weight: 700;
             padding: 1rem 1.5rem;
             text-align: left;
             font-size: 0.875rem;
             text-transform: uppercase;
             letter-spacing: 0.05em;
        }
        .table-cell {
            padding: 1rem 1.5rem;
            white-space: nowrap;
        }
        .checked-in-row {
            background-color: var(--checked-in-bg);
            color: var(--checked-in-text);
        }
         .checked-in-row .checkbox-magical {
            border-color: var(--hp-sage-green);
        }
        .unchecked-row {
            background-color: var(--unchecked-bg);
            color: var(--unchecked-text);
        }
        .unchecked-row .checkbox-magical {
             border-color: var(--hp-golden);
        }

        /* å®¶åº­ç¾¤çµ„æ¨£å¼ - ç²—æ¡†ç‰ˆæœ¬ */
        .family-group-first {
            border: none;
            border-radius: 8px 8px 0 0;
            background: rgba(23, 145, 207, 0.02);
        }

        .family-group-middle {
            border: none;
            background: rgba(23, 145, 207, 0.02);
        }

        .family-group-last {
            border: none;
            border-radius: 0 0 8px 8px;
            background: rgba(23, 145, 207, 0.02);
        }

        .family-group-single {
            border: none;
            border-radius: 8px;
            background: rgba(23, 145, 207, 0.02);
        }

        /* å®¶åº­ç¾¤çµ„å·²å ±åˆ°æ¨£å¼ - ç¶ åº•é»‘å­— */
        .family-group-first.checked-in-row {
            background-color: #e8f5e8;
            color: #000000;
            border-color: #4caf50;
        }

        .family-group-middle.checked-in-row {
            background-color: #e8f5e8;
            color: #000000;
            border-color: #4caf50;
        }

        .family-group-last.checked-in-row {
            background-color: #e8f5e8;
            color: #000000;
            border-color: #4caf50;
        }

        .family-group-single.checked-in-row {
            background-color: #e8f5e8;
            color: #000000;
            border-color: #4caf50;
        }

        /* å®¶åº­ç·¨è™Ÿæ¨™è¨˜ */
        .family-group-first .table-cell:first-child::after,
        .family-group-single .table-cell:first-child::after {
            content: "ğŸ‘ª";
            position: absolute;
            margin-left: 5px;
            font-size: 12px;
            opacity: 0.7;
        }
    </style>
</head>
<body class="bg-[var(--background-color)]">
<div class="relative flex size-full min-h-screen flex-col group/design-root overflow-x-hidden">
<div class="layout-container flex h-full grow flex-col">
<header class="magical-header flex items-center justify-between whitespace-nowrap px-6 py-6 md:px-10">
<div class="flex items-center gap-4 text-white">
<span class="material-symbols-outlined text-4xl text-[var(--hp-parchment)] magic-sparkle">auto_stories</span>
<div>
<h1 class="hogwarts-title text-2xl md:text-3xl font-bold leading-tight">é è¨€å®¶æ—¥å ±</h1>
<p class="text-[var(--hp-parchment)] text-sm opacity-90">Hogwarts Guest Registry</p>
</div>
</div>
<div class="flex flex-1 justify-end gap-6">
<nav class="flex items-center gap-8">
<a class="text-sm font-medium text-[var(--text-color)] hover:text-[var(--primary-color)] transition-colors" href="../../index.html">Home</a>
<a class="text-sm font-medium text-[var(--primary-color)] font-semibold" href="#">Guests</a>
<a class="text-sm font-medium text-[var(--text-color)] hover:text-[var(--primary-color)] transition-colors" href="checkin.html">Check In</a>
<a class="text-sm font-medium text-[var(--text-color)] hover:text-[var(--primary-color)] transition-colors" href="gringotts.html">Vault</a>
</nav>
</div>
</div>
</header>
<main class="flex-1 p-6 sm:p-10">
<div class="mx-auto max-w-7xl">
<div class="flex flex-col items-center gap-4 mb-8">
<h2 class="text-3xl font-bold text-[var(--hp-brown)] tracking-tight text-center">è³“å®¢åå†Š</h2>
</div>
<div class="magic-table rounded-2xl overflow-hidden">
<!-- å ±åˆ°é€²åº¦æ¢ -->
<div class="p-6 border-b border-[var(--subtle-border)] bg-gradient-to-r from-blue-50 to-purple-50">
<div class="max-w-4xl mx-auto">
<div class="flex items-center justify-between mb-2">
<h3 class="text-sm font-semibold text-gray-700 flex items-center gap-2">
<span class="material-symbols-outlined text-lg">checklist</span>
å ±åˆ°é€²åº¦
</h3>
<div id="progress-stats" class="text-sm font-bold text-gray-800">
<span id="checked-in-count">0</span> / <span id="total-count">0</span> äºº
<span class="text-xs text-gray-600 ml-2">(<span id="progress-percentage">0</span>%)</span>
</div>
</div>
<!-- é€²åº¦æ¢ -->
<div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden shadow-inner">
<div id="progress-bar" class="bg-gradient-to-r from-green-400 to-green-600 h-3 rounded-full transition-all duration-500 ease-out shadow-sm" style="width: 0%"></div>
</div>
</div>
</div>

<!-- æœå°‹æ¬„ä½ -->
<div class="p-6 border-b border-[var(--subtle-border)]">
<div class="flex flex-col sm:flex-row sm:items-center sm:justify-center gap-4">
<div class="relative max-w-md w-full">
<span class="material-symbols-outlined absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">search</span>
<input type="text" id="search-input" placeholder="æœå°‹ç·¨è™Ÿæˆ–å§“å..."
       class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none transition-all">
<button id="clear-search" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 hidden">
<span class="material-symbols-outlined text-lg">close</span>
</button>
</div>
<div class="flex justify-center" id="guestlist-actions"></div>
</div>
</div>
<div class="overflow-x-auto">
<table class="w-full text-sm">
<thead>
<tr>
<th class="table-header">åºè™Ÿ</th>
<th class="table-header">è³“å®¢å§“å</th>
<th class="table-header text-center">å®¶åº­ç·¨è™Ÿ</th>
<th class="table-header text-center">æ”¶ç¦®é‡‘</th>
<th class="table-header text-center">æœ‰å–œé¤…</th>
<th class="table-header text-center">ç‹€æ…‹</th>
</tr>
</thead>
<tbody id="guest-table-body" class="divide-y divide-[var(--subtle-border)]">
                            <!-- è¼‰å…¥ä¸­çš„æç¤º -->
                            <tr id="loading-row">
                                <td colspan="6" class="table-cell text-center py-8">
                                    <span class="material-symbols-outlined animate-spin text-2xl text-[var(--primary-color)]">refresh</span>
                                    <div class="mt-2 text-gray-500">è¼‰å…¥è³“å®¢è³‡æ–™ä¸­...</div>
                                </td>
                            </tr>
                        </tbody>
</table>
</div>

<!-- åˆ†é è³‡è¨Šå’Œå°èˆª -->
<div class="px-6 py-4 border-t border-[var(--subtle-border)] bg-gray-50">
<div class="flex flex-col sm:flex-row justify-between items-center gap-4">
<!-- è³‡è¨Šé¡¯ç¤º -->
<div class="text-sm text-gray-600">
<span id="pagination-info">é¡¯ç¤ºç¬¬ 1-20 ç­†ï¼Œå…± 0 ç­†è³“å®¢</span>
</div>

<!-- åˆ†é å°èˆª -->
<div class="flex items-center space-x-1">
<!-- ä¸Šä¸€é æŒ‰éˆ• -->
<button id="prev-page" class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-l-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
<span class="material-symbols-outlined text-lg">chevron_left</span>
</button>

<!-- é ç¢¼æŒ‰éˆ•å®¹å™¨ -->
<div id="page-numbers" class="flex space-x-1">
<!-- é ç¢¼æŒ‰éˆ•æœƒå‹•æ…‹ç”Ÿæˆ -->
</div>

<!-- ä¸‹ä¸€é æŒ‰éˆ• -->
<button id="next-page" class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-r-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
<span class="material-symbols-outlined text-lg">chevron_right</span>
</button>
</div>
</div>
</div>

</div>
</div>
</main>
</div>
</div>

<script>
    // Google Apps Script URL å¾é…ç½®æ–‡ä»¶è¼‰å…¥
    let GOOGLE_SCRIPT_READ_URL = window.CONFIG?.GOOGLE_SCRIPT_URL || (() => { alert('è«‹å…ˆè¨­å®š config.js é…ç½®æ–‡ä»¶ï¼'); return ''; })();

    // ğŸ¯ Linus: ä¿®å¾© Google å¤šå¸³è™Ÿç™»å…¥å°è‡´çš„ /u/X/ è·¯å¾‘å•é¡Œ
    // Google å¤šå¸³è™Ÿç™»å…¥æœƒè‡ªå‹•å°‡ URL å¾ /macros/s/ æ”¹æˆ /macros/u/1/s/ï¼Œå°è‡´ 404
    // é€™æ˜¯ Google Apps Script çš„å·²çŸ¥å•é¡Œï¼Œéœ€è¦å¼·åˆ¶ç§»é™¤ /u/X/ å‰ç¶´
    if (GOOGLE_SCRIPT_READ_URL && GOOGLE_SCRIPT_READ_URL.includes('/macros/u/')) {
        console.warn('âš ï¸ åµæ¸¬åˆ° Google å¤šå¸³è™Ÿ URL (æœƒå°è‡´ 404):', GOOGLE_SCRIPT_READ_URL);
        GOOGLE_SCRIPT_READ_URL = GOOGLE_SCRIPT_READ_URL.replace(/\/macros\/u\/\d+\/s\//g, '/macros/s/');
        console.log('âœ… å·²ä¿®æ­£ç‚ºæ­£ç¢º URL:', GOOGLE_SCRIPT_READ_URL);

        // æ¸…é™¤èˆŠçš„ cacheï¼Œå› ç‚ºå¯èƒ½åŒ…å«éŒ¯èª¤çš„ URL
        console.log('ğŸ§¹ æ¸…é™¤èˆŠå¿«å–...');
        localStorage.removeItem('wedding_guest_data');
        localStorage.removeItem('wedding_guest_data_time');
    }

    let guestData = []; // å…¨éƒ¨è³“å®¢è³‡æ–™
    let filteredData = []; // æœå°‹éæ¿¾å¾Œçš„è³‡æ–™
    let currentSearchTerm = ''; // ç›®å‰çš„æœå°‹é—œéµå­—
    let lastDataUpdateTime = 0; // æœ€å¾Œè³‡æ–™æ›´æ–°æ™‚é–“

    // ğŸ—„ï¸ æŒä¹…åŒ–ç·©å­˜é…ç½®
    const CACHE_KEY = 'wedding_guest_data';
    const CACHE_TIME_KEY = 'wedding_guest_data_time';
    const CACHE_DURATION = 5 * 60 * 1000; // 5åˆ†é˜ç·©å­˜

    // åˆ†é è®Šæ•¸
    const itemsPerPage = 20;
    let currentPage = 1;

    // ğŸ—„ï¸ æŒä¹…åŒ–ç·©å­˜ç®¡ç†
    function saveCacheToStorage() {
        try {
            localStorage.setItem(CACHE_KEY, JSON.stringify(guestData));
            localStorage.setItem(CACHE_TIME_KEY, lastDataUpdateTime.toString());
        } catch (error) {
            console.warn('âš ï¸ localStorage ä¿å­˜å¤±æ•—:', error);
        }
    }

    function loadCacheFromStorage() {
        try {
            const cachedData = localStorage.getItem(CACHE_KEY);
            const cachedTime = localStorage.getItem(CACHE_TIME_KEY);

            if (cachedData && cachedTime) {
                const cacheAge = Date.now() - parseInt(cachedTime);
                if (cacheAge < CACHE_DURATION) {
                    guestData = JSON.parse(cachedData);
                    lastDataUpdateTime = parseInt(cachedTime);
                    return true;
                } else {
                    clearCacheFromStorage();
                }
            }
        } catch (error) {
            console.warn('âš ï¸ localStorage è®€å–å¤±æ•—:', error);
            clearCacheFromStorage();
        }
        return false;
    }

    function clearCacheFromStorage() {
        try {
            localStorage.removeItem(CACHE_KEY);
            localStorage.removeItem(CACHE_TIME_KEY);
        } catch (error) {
            console.warn('âš ï¸ localStorage æ¸…é™¤å¤±æ•—:', error);
        }
    }

    // ğŸ”„ æ›´æ–°æœ¬åœ°ç·©å­˜
    function updateCacheData(newData) {
        guestData = newData;
        lastDataUpdateTime = Date.now();
        saveCacheToStorage();
    }

    // ğŸ” ç·©å­˜ç‹€æ…‹æª¢æŸ¥ï¼ˆé–‹ç™¼è€…å·¥å…·ç”¨ï¼‰
    window.checkCacheStatus = function() {
        console.log('=== å©šç¦®ç³»çµ±ç·©å­˜ç‹€æ…‹ ===');
        console.log('è¨˜æ†¶é«”ç·©å­˜ç­†æ•¸:', guestData.length);
        console.log('æœ€å¾Œæ›´æ–°æ™‚é–“:', lastDataUpdateTime ? new Date(lastDataUpdateTime) : 'ç„¡');
        console.log('ç·©å­˜å¹´é½¡:', lastDataUpdateTime ? `${Math.round((Date.now() - lastDataUpdateTime) / 1000)}ç§’` : 'ç„¡');
        console.log('è¨˜æ†¶é«”ç·©å­˜æœ‰æ•ˆ:', Date.now() - lastDataUpdateTime < CACHE_DURATION);

        const storageData = localStorage.getItem(CACHE_KEY);
        const storageTime = localStorage.getItem(CACHE_TIME_KEY);
        console.log('localStorage æœ‰è³‡æ–™:', !!storageData);
        console.log('localStorage æ™‚é–“:', storageTime ? new Date(parseInt(storageTime)) : 'ç„¡');

        // æª¢æŸ¥ localStorage ä¸­çš„è³‡æ–™ç­†æ•¸
        if (storageData) {
            try {
                const parsed = JSON.parse(storageData);
                console.log('localStorage è³‡æ–™ç­†æ•¸:', parsed.length);
            } catch (e) {
                console.log('localStorage è³‡æ–™è§£æå¤±æ•—');
            }
        }

        if (guestData.length > 0) {
            console.log('å‰3ç­†è³‡æ–™:', guestData.slice(0, 3));
            console.log('æœ€å¾Œ3ç­†è³‡æ–™:', guestData.slice(-3));

            // æª¢æŸ¥æ˜¯å¦æœ‰ä¸åŒé é¢çš„è³‡æ–™
            const serialNumbers = guestData.map(g => g.serialNumber).sort((a, b) => a - b);
            console.log('åºè™Ÿç¯„åœ:', `${serialNumbers[0]} - ${serialNumbers[serialNumbers.length - 1]}`);
            console.log('æ˜¯å¦é€£çºŒ:', serialNumbers.length === (serialNumbers[serialNumbers.length - 1] - serialNumbers[0] + 1));
        }

        // è¿”å›ç‹€æ…‹æ‘˜è¦
        return {
            memoryCache: guestData.length,
            memoryCacheValid: Date.now() - lastDataUpdateTime < CACHE_DURATION,
            localStorageHasData: !!storageData,
            localStorageCount: storageData ? JSON.parse(storageData).length : 0,
            cacheAge: Math.round((Date.now() - lastDataUpdateTime) / 1000)
        };
    };

    // ğŸš€ æ€§èƒ½å„ªåŒ–ï¼šæ™ºèƒ½è¼‰å…¥è³‡æ–™ï¼ˆé›™è»Œç­–ç•¥ï¼‰
    function smartLoadGuestData(forceReload = false) {
        // å„ªå…ˆå˜—è©¦å¾ localStorage æ¢å¾©ç·©å­˜
        if (!forceReload && guestData.length === 0) {
            loadCacheFromStorage();
        }

        // æª¢æŸ¥è¨˜æ†¶é«”ç·©å­˜æ˜¯å¦æœ‰æ•ˆ
        const cacheIsValid = !forceReload && guestData.length > 0 &&
            Date.now() - lastDataUpdateTime < CACHE_DURATION;

        if (cacheIsValid) {
            // ğŸ¯ é›™è»Œç­–ç•¥ï¼šå…ˆç”¨ cache å¿«é€Ÿé¡¯ç¤º
            console.log('ğŸ“¦ ä½¿ç”¨å¿«å–å¿«é€Ÿé¡¯ç¤ºï¼ŒèƒŒæ™¯åŒæ­¥æœ€æ–°è³‡æ–™...');
            filteredData = [...guestData];
            updateProgressBar(); // æ›´æ–°é€²åº¦æ¢
            renderGuestTable();

            // èƒŒæ™¯å·å·é‡æ–°è¼‰å…¥å®Œæ•´è³‡æ–™
            setTimeout(() => {
                console.log('ğŸ”„ èƒŒæ™¯é‡æ–°è¼‰å…¥å®Œæ•´è³‡æ–™...');
                loadGuestData();
            }, 100);
            return;
        }

        // Cache ç„¡æ•ˆæˆ–å¼·åˆ¶é‡è¼‰ï¼Œç›´æ¥è¼‰å…¥
        loadGuestData();
    }

    // ğŸ”„ æœ¬åœ°æ›´æ–°è³“å®¢è³‡æ–™ï¼ˆé¿å…é‡æ–°è«‹æ±‚ï¼‰
    function updateLocalGuestData(checkInData) {
        const { serialNumber, guestName, familyId, collectMoney, giftAmount, redEnvelopeNo, hasCake, cakeGiven, remarks } = checkInData;

        // æ›´æ–°å ±åˆ°æ“ä½œè€…
        const guestIndex = guestData.findIndex(guest =>
            guest.serialNumber === parseInt(serialNumber)
        );

        if (guestIndex === -1) {
            loadGuestData();
            return;
        }

        const now = new Date().toISOString();

        // ğŸ¯ å¥½å“å‘³ï¼šæ•¸æ“šæ›´æ–°çµ±ä¸€åŒ–
        const checkInUpdate = {
            checkedIn: true,
            timestamp: now
        };

        const giftUpdate = {
            collectMoney: Boolean(collectMoney),
            giftAmount: Number(giftAmount) || 0,
            redEnvelopeNo: collectMoney ? String(redEnvelopeNo || '').trim() : '',
            hasCake: Boolean(hasCake),
            cakeGiven: Boolean(cakeGiven),
            remarks: String(remarks || '').trim()
        };

        // ä¸»è¦å ±åˆ°è€…ç²å¾—å®Œæ•´æ›´æ–°
        guestData[guestIndex] = { ...guestData[guestIndex], ...checkInUpdate, ...giftUpdate };

        // å®¶åº­æˆå“¡åªç²å¾—å ±åˆ°ç‹€æ…‹æ›´æ–°ï¼Œç„¡ç‰¹æ®Šæƒ…æ³åˆ¤æ–·
        const updatedCount = familyId ?
            updateFamilyMembers(familyId, guestIndex, checkInUpdate) + 1 : 1;

        // æ›´æ–°ç¯©é¸è³‡æ–™å’Œé¡¯ç¤º
        filteredData = [...guestData];
        if (currentSearchTerm) {
            filterGuests(currentSearchTerm);
        } else {
            renderGuestTable();
        }

        // ä¿å­˜æ›´æ–°å¾Œçš„è³‡æ–™åˆ° localStorage
        saveCacheToStorage();

        updatePaginationDisplay()
    }

    // ğŸ¯ å¥½å“å‘³ï¼šç´”å‡½æ•¸ï¼Œè·è²¬å–®ä¸€
    function updateFamilyMembers(familyId, skipIndex, updateData) {
        let count = 0;
        guestData.forEach((guest, index) => {
            if (guest.familyId === familyId && index !== skipIndex) {
                guestData[index] = { ...guestData[index], ...updateData };
                count++;
            }
        });
        return count;
    }

    // ğŸ§¹ å¾¹åº•æ¸…ç†æ‰€æœ‰ JSONP æ®˜ç•™
    function cleanupAllJSONP() {
        // æ¸…ç†æ‰€æœ‰ JSONP script æ¨™ç±¤
        document.querySelectorAll('script[data-jsonp]').forEach(script => script.remove());

        // æ¸…ç†æ‰€æœ‰ç›¸é—œçš„å…¨åŸŸ callback
        Object.keys(window).forEach(key => {
            if (key.startsWith('handleGuestData')) {
                delete window[key];
            }
        });
    }

    // è¼‰å…¥å…¨éƒ¨è³“å®¢è³‡æ–™ - ä½¿ç”¨ JSONP
    function loadGuestData() {
        // ğŸ¯ Linus: å¾¹åº•æ¸…ç†ï¼Œä¸ç•™ä»»ä½•æ®˜ç•™
        cleanupAllJSONP();

        // è¨­å®šå…¨åŸŸå›èª¿å‡½æ•¸
        window.handleGuestData = function(response) {

            // æª¢æŸ¥æ˜¯å¦æœ‰éŒ¯èª¤æˆ–è€…æ˜¯åˆ†é è³‡æ–™æ ¼å¼
            if (response.error) {
                console.error('ä¼ºæœå™¨éŒ¯èª¤:', response.error);
                document.getElementById('guest-table-body').innerHTML = `
                    <tr>
                        <td colspan="5" class="table-cell text-center py-8">
                            <span class="material-symbols-outlined text-2xl text-red-500">error</span>
                            <div class="mt-2 text-red-500">è¼‰å…¥è³‡æ–™å¤±æ•—ï¼š${response.message || 'æœªçŸ¥éŒ¯èª¤'}</div>
                            <button onclick="loadGuestData()" class="btn-primary mt-2">
                                <span class="material-symbols-outlined">refresh</span> é‡æ–°è¼‰å…¥
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }

            // åˆ¤æ–·æ˜¯åˆ†é æ ¼å¼é‚„æ˜¯åŸæœ¬çš„é™£åˆ—æ ¼å¼
            if (response.data && Array.isArray(response.data)) {
                // æ–°çš„åˆ†é æ ¼å¼ï¼Œä½†æˆ‘å€‘å–æ‰€æœ‰é é¢çš„è³‡æ–™
                guestData = response.data;
            } else if (Array.isArray(response)) {
                // åŸæœ¬çš„é™£åˆ—æ ¼å¼
                guestData = response;
            } else {
                console.error('æœªçŸ¥çš„è³‡æ–™æ ¼å¼:', response);
                guestData = [];
            }

            // ğŸ¯ ç°¡å–®æœ‰æ•ˆï¼šå¦‚æœæœ‰åˆ†é å°±è‡ªå‹•è¼‰å…¥å…¨éƒ¨
            if (response.pagination && response.pagination.hasNextPage) {
                // ç›´æ¥è¼‰å…¥ä¸‹ä¸€é ä¸¦ç´¯ç©åˆ°ç¾æœ‰è³‡æ–™
                loadMorePages(response.pagination.currentPage + 1, guestData);
                return; // ç­‰å¾…æ‰€æœ‰é é¢è¼‰å…¥å®Œæˆå†è™•ç† UI
            } else {
                // åªæœ‰ä¸€é ï¼Œç›´æ¥å®Œæˆ UI æ›´æ–°
                finishDataLoadingAndUpdateUI(guestData);
            }
        };

        // å‰µå»º JSONP script æ¨™ç±¤ï¼Œä¸è¦åˆ†é åƒæ•¸ï¼Œå–å¾—å…¨éƒ¨è³‡æ–™
        const script = document.createElement('script');
        script.setAttribute('data-jsonp', 'guestlist');

        // ğŸ¯ Linus: ä¿®å¾© Google å¤šå¸³è™Ÿè‡ªå‹•æ”¹å¯« URL çš„å•é¡Œ
        // è¨­å®š crossorigin="anonymous" å¼·åˆ¶ä¸å¸¶ cookiesï¼Œé¿å…è¢«æ”¹å¯«æˆ /u/1/
        script.crossOrigin = 'anonymous';

        // ğŸš€ æ¼¸é€²å¼è¼‰å…¥ï¼šå…ˆå˜—è©¦ç²å–æ›´å¤šè³‡æ–™ï¼Œå¯¦éš›æ”¶åˆ°å¤šå°‘å°±ç·©å­˜å¤šå°‘
        const params = new URLSearchParams({
            action: 'getGuests',
            callback: 'handleGuestData',
            limit: 999999, // å˜—è©¦ç²å–å…¨éƒ¨ï¼Œå¯¦éš›èƒ½æ‹¿å¤šå°‘å°±æ‹¿å¤šå°‘
            page: 1,
            _t: Date.now()
        });

        const finalURL = `${GOOGLE_SCRIPT_READ_URL}?${params.toString()}`;

        // ğŸ” Debug: è¨˜éŒ„å¯¦éš›è«‹æ±‚çš„ URL
        console.log('ğŸ“¡ JSONP è«‹æ±‚ URL:', finalURL);

        // ğŸ¯ Linus: ç¹éç€è¦½å™¨çš„è‡ªå‹•é‡å®šå‘
        // å•é¡Œï¼šç€è¦½å™¨æœƒè‡ªå‹•å°‡ /macros/s/ æ”¹æˆ /macros/u/1/s/
        // è§£æ±ºï¼šç”¨ fetch ç›´æ¥å–å¾— script å…§å®¹ï¼Œå†ç”¨ Blob URL åŸ·è¡Œ
        fetch(finalURL, {
            method: 'GET',
            mode: 'no-cors', // é¿å… CORS å•é¡Œ
            credentials: 'omit' // ä¸å¸¶ cookiesï¼Œé¿å…å¤šå¸³è™Ÿå¹²æ“¾
        })
        .then(response => {
            // å› ç‚º no-cors æ¨¡å¼ç„¡æ³•è®€å– responseï¼Œæ‰€ä»¥ç›´æ¥ç”¨åŸå§‹ URL ä½œç‚º script src
            // ä½†åŠ ä¸Šç‰¹æ®Šåƒæ•¸å¼·åˆ¶ç¹é cache
            script.src = finalURL + '&_nocache=' + Math.random();
            document.head.appendChild(script);
        })
        .catch(error => {
            console.error('âŒ JSONP è«‹æ±‚å¤±æ•—:', error);
            console.error('å¤±æ•—çš„ URL:', finalURL);

            document.getElementById('guest-table-body').innerHTML = `
                <tr>
                    <td colspan="5" class="table-cell text-center py-8">
                        <span class="material-symbols-outlined text-2xl text-red-500">error</span>
                        <div class="mt-2 text-red-500">ç¶²è·¯é€£æ¥å¤±æ•—</div>
                        <button onclick="loadGuestData()" class="btn-primary mt-2">
                            <span class="material-symbols-outlined">refresh</span> é‡æ–°è¼‰å…¥
                        </button>
                    </td>
                </tr>
            `;
        });

        // éŒ¯èª¤è™•ç†ï¼ˆå¦‚æœ script è¼‰å…¥å¤±æ•—ï¼‰
        script.onerror = function() {
            console.error('âŒ Script åŸ·è¡Œå¤±æ•—');
            console.error('å¤±æ•—çš„ URL:', script.src);

            document.getElementById('guest-table-body').innerHTML = `
                <tr>
                    <td colspan="5" class="table-cell text-center py-8">
                        <span class="material-symbols-outlined text-2xl text-red-500">error</span>
                        <div class="mt-2 text-red-500">ç¶²è·¯é€£æ¥å¤±æ•—</div>
                        <button onclick="loadGuestData()" class="btn-primary mt-2">
                            <span class="material-symbols-outlined">refresh</span> é‡æ–°è¼‰å…¥
                        </button>
                    </td>
                </tr>
            `;
        };

    }

    // çµ±ä¸€çš„ UI æ›´æ–°å‡½æ•¸
    function finishDataLoadingAndUpdateUI(finalData) {
        guestData = finalData;

        // åˆå§‹åŒ–ç¯©é¸è³‡æ–™
        filteredData = [...guestData];

        // è¨­ç½®è³‡æ–™æ›´æ–°æ™‚é–“ä¸¦ä¿å­˜è‡³ localStorage
        updateCacheData(guestData);

        // å¦‚æœæœ‰æœå°‹é—œéµå­—ï¼Œé€²è¡Œç¯©é¸
        if (currentSearchTerm) {
            filterGuests(currentSearchTerm);
        } else {
            // æ›´æ–°åˆ†é é¡¯ç¤ºå’Œé€²åº¦æ¢
            updatePaginationDisplay();
            renderGuestTable();
        }
    }

    // è¼‰å…¥å‰©é¤˜é é¢çš„è³‡æ–™
    function loadMorePages(pageNumber, accumulatedData) {
        // è¨­å®šé€™å€‹é é¢çš„å›èª¿å‡½æ•¸
        window[`handleGuestDataPage${pageNumber}`] = function(response) {

            let currentPageData = [];
            if (response.data && Array.isArray(response.data)) {
                currentPageData = response.data;
            } else if (Array.isArray(response)) {
                currentPageData = response;
            }

            // ç´¯ç©è³‡æ–™
            const totalData = [...accumulatedData, ...currentPageData];

            // æª¢æŸ¥æ˜¯å¦é‚„æœ‰ä¸‹ä¸€é 
            if (response.pagination && response.pagination.hasNextPage) {
                // ç¹¼çºŒè¼‰å…¥ä¸‹ä¸€é 
                loadMorePages(pageNumber + 1, totalData);
            } else {
                // æ‰€æœ‰é é¢è¼‰å…¥å®Œæˆï¼Œçµ±ä¸€æ›´æ–° UI
                finishDataLoadingAndUpdateUI(totalData);
            }
        };

        // å‰µå»ºæ–°çš„ JSONP script
        const script = document.createElement('script');
        script.setAttribute('data-jsonp', `guestlist-page-${pageNumber}`);

        // ğŸ¯ Linus: ä¿®å¾© Google å¤šå¸³è™Ÿè‡ªå‹•æ”¹å¯« URL çš„å•é¡Œ
        script.crossOrigin = 'anonymous';

        const params = new URLSearchParams({
            action: 'getGuests',
            callback: `handleGuestDataPage${pageNumber}`,
            page: pageNumber,
            _t: Date.now()
        });

        const finalURL = `${GOOGLE_SCRIPT_READ_URL}?${params.toString()}`;
        script.src = finalURL;

        console.log(`ğŸ“¡ è¼‰å…¥ç¬¬ ${pageNumber} é :`, finalURL);

        script.onerror = function() {
            console.error(`âŒ ç¬¬ ${pageNumber} é è¼‰å…¥å¤±æ•—`);
            console.error('å¤±æ•—çš„ URL:', script.src);
            console.error(`ä½¿ç”¨å·²è¼‰å…¥çš„ ${accumulatedData.length} ç­†è³‡æ–™`);
            // è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨å·²æœ‰è³‡æ–™ï¼Œçµ±ä¸€æ›´æ–° UI
            finishDataLoadingAndUpdateUI(accumulatedData);
        };

        document.head.appendChild(script);
    }

    // ğŸ¯ æ›´æ–°å ±åˆ°é€²åº¦æ¢
    function updateProgressBar() {
        const totalCount = guestData.length;
        const checkedInCount = guestData.filter(guest => guest.checkedIn || guest.timestamp).length;
        const percentage = totalCount > 0 ? Math.round((checkedInCount / totalCount) * 100) : 0;

        // æ›´æ–° DOM å…ƒç´ 
        document.getElementById('checked-in-count').textContent = checkedInCount;
        document.getElementById('total-count').textContent = totalCount;
        document.getElementById('progress-percentage').textContent = percentage;
        document.getElementById('progress-bar').style.width = `${percentage}%`;
    }

    // æ›´æ–°åˆ†é é¡¯ç¤ºï¼ˆåŸºæ–¼æœ¬åœ°è³‡æ–™ï¼‰
    function updatePaginationDisplay() {
        updatePaginationInfo();
        updatePaginationButtons();
        updateProgressBar(); // åŒæ™‚æ›´æ–°é€²åº¦æ¢
    }

    // æ›´æ–°åˆ†é è³‡è¨Šé¡¯ç¤º
    function updatePaginationInfo() {
        const totalRecords = filteredData.length;
        const start = totalRecords === 0 ? 0 : ((currentPage - 1) * itemsPerPage) + 1;
        const end = Math.min(currentPage * itemsPerPage, totalRecords);

        document.getElementById('pagination-info').textContent =
            `é¡¯ç¤ºç¬¬ ${start}-${end} ç­†ï¼Œå…± ${totalRecords} ç­†è³“å®¢`;
    }

    // æ›´æ–°åˆ†é æŒ‰éˆ•
    function updatePaginationButtons() {
        const prevBtn = document.getElementById('prev-page');
        const nextBtn = document.getElementById('next-page');
        const pageNumbers = document.getElementById('page-numbers');

        const totalRecords = filteredData.length;
        const totalPages = Math.ceil(totalRecords / itemsPerPage);
        const hasPrevPage = currentPage > 1;
        const hasNextPage = currentPage < totalPages;

        // ä¸Šä¸€é /ä¸‹ä¸€é æŒ‰éˆ•ç‹€æ…‹
        prevBtn.disabled = !hasPrevPage;
        nextBtn.disabled = !hasNextPage;

        // ç”Ÿæˆé ç¢¼æŒ‰éˆ•
        pageNumbers.innerHTML = '';

        // è¨ˆç®—é¡¯ç¤ºçš„é ç¢¼ç¯„åœ
        const maxButtons = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
        let endPage = Math.min(totalPages, startPage + maxButtons - 1);

        // èª¿æ•´èµ·å§‹é é¢
        if (endPage - startPage + 1 < maxButtons) {
            startPage = Math.max(1, endPage - maxButtons + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
            const button = document.createElement('button');
            button.textContent = i;
            button.className = `px-3 py-2 text-sm font-medium border ${
                i === currentPage
                    ? 'bg-[var(--primary-color)] text-white border-[var(--primary-color)]'
                    : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50'
            }`;
            button.onclick = () => goToPage(i);
            pageNumbers.appendChild(button);
        }
    }

    // è·³è½‰åˆ°æŒ‡å®šé é¢ï¼ˆå‰ç«¯åˆ†é ï¼‰
    function goToPage(page) {
        const totalPages = Math.ceil(filteredData.length / itemsPerPage);
        if (page >= 1 && page <= totalPages) {
            currentPage = page;
            updatePaginationDisplay();
            renderGuestTable();
        }
    }

    // æ¸²æŸ“è³“å®¢è¡¨æ ¼ï¼ˆæ”¯æ´å®¶åº­ç¾¤çµ„æ©¢åœ“å½¢é¡¯ç¤ºï¼‰
    function renderGuestTable() {
        const tbody = document.getElementById('guest-table-body');

        if (filteredData.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="table-cell text-center py-8">
                        <span class="material-symbols-outlined text-2xl text-gray-400">person_off</span>
                        <div class="mt-2 text-gray-500">
                            ${currentSearchTerm ? 'æ²’æœ‰ç¬¦åˆæœå°‹æ¢ä»¶çš„è³“å®¢' : 'å°šç„¡è³“å®¢è³‡æ–™'}
                        </div>
                    </td>
                </tr>
            `;
            return;
        }

        // ğŸ¯ åŸºæ–¼å®Œæ•´å¿«å–è³‡æ–™çš„å‰ç«¯åˆ†é 
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const currentPageData = filteredData.slice(startIndex, endIndex);

        // æŒ‰å®¶åº­ç¾¤çµ„æ•´ç†è³‡æ–™
        const groupedData = groupGuestsByFamily(currentPageData);

        tbody.innerHTML = groupedData.map(guest => {
            const isCheckedIn = guest.checkedIn;
            const rowClass = isCheckedIn ? 'checked-in-row' : 'unchecked-row';
            const buttonClass = isCheckedIn ? 'btn-hogwarts bg-green-200 text-green-800 hover:bg-green-300' : 'btn-hogwarts';
            const buttonText = isCheckedIn ? '<span class="material-symbols-outlined magic-sparkle">edit</span> å·²å ±åˆ°' : '<span class="material-symbols-outlined magic-sparkle">login</span> æœªå ±åˆ°';
            const buttonAction = `goToCheckin('${guest.serialNumber}', '${guest.guestName}', ${guest.collectMoney}, ${guest.hasCake})`;

            // æ·»åŠ å®¶åº­ç¾¤çµ„æ¨£å¼
            const familyGroupClass = guest.familyGroupClass || '';
            const familyDisplay = guest.familyId ? `<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs">${guest.familyId}</span>` : '-';

            const collectMoneyText = guest.collectMoney ? 'æ”¶ç¦®é‡‘' : 'ä¸æ”¶ç¦®é‡‘';
            const hasCakeText = guest.hasCake ? 'æœ‰å–œé¤…' : 'ç„¡å–œé¤…';

            return `
                <tr class="transition-colors ${rowClass} ${familyGroupClass}">
                    <td class="table-cell">${guest.serialNumber}</td>
                    <td class="table-cell font-medium">${guest.guestName}</td>
                    <td class="table-cell text-center">${familyDisplay}</td>
                    <td class="table-cell text-center text-sm font-medium ${guest.collectMoney ? 'text-green-700' : 'text-gray-500'}">${collectMoneyText}</td>
                    <td class="table-cell text-center text-sm font-medium ${guest.hasCake ? 'text-purple-700' : 'text-gray-500'}">${hasCakeText}</td>
                    <td class="table-cell text-right">
                        <button class="${buttonClass}" onclick="${buttonAction}">
                            ${buttonText}
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // ğŸ¯ å¥½å“å‘³é‡å¯«ï¼šçœŸæ­£æ¶ˆé™¤ç‰¹æ®Šæƒ…æ³
    function groupGuestsByFamily(guests) {
        const result = [];
        const familyMap = new Map();

        // åˆ†é›¢å®¶åº­æˆå“¡å’Œå€‹äººè³“å®¢
        guests.forEach(guest => {
            if (guest.familyId) {
                if (!familyMap.has(guest.familyId)) {
                    familyMap.set(guest.familyId, []);
                }
                familyMap.get(guest.familyId).push(guest);
            } else {
                // å€‹äººè³“å®¢ä¸éœ€è¦ä»»ä½•å®¶åº­æ¨™è¨˜
                guest.familyGroupClass = '';
                result.push(guest);
            }
        });

        // åªè™•ç†çœŸæ­£çš„å®¶åº­ç¾¤çµ„
        familyMap.forEach(family => {
            family.forEach((guest, index) => {
                guest.familyGroupClass = calculateFamilyPosition(family.length, index);
                result.push(guest);
            });
        });

        return result;
    }

    // ç´”å‡½æ•¸ï¼šåªè™•ç†çœŸå¯¦çš„å®¶åº­ä½ç½®
    function calculateFamilyPosition(familySize, index) {
        if (familySize === 1) return 'family-group-single';
        if (index === 0) return 'family-group-first';
        if (index === familySize - 1) return 'family-group-last';
        return 'family-group-middle';
    }

    // æŸ¥çœ‹è³“å®¢è©³ç´°è³‡è¨Š
    function viewGuestDetails(serialNumber) {
        const guest = guestData.find(g => g.serialNumber === parseInt(serialNumber));
        if (guest) {
            const details = `
è³“å®¢ç·¨è™Ÿ: ${guest.serialNumber}
å§“å: ${guest.guestName}
æ”¶ç¦®é‡‘: ${guest.collectMoney ? 'æ˜¯' : 'å¦'}
${guest.collectMoney && guest.giftAmount ? `ç¦®é‡‘é‡‘é¡: ${guest.giftAmount}` : ''}
${guest.collectMoney && guest.redEnvelopeNo ? `ç´…åŒ…ç·¨è™Ÿ: ${guest.redEnvelopeNo}` : ''}
æœ‰å–œé¤…: ${guest.hasCake ? 'æ˜¯' : 'å¦'}
ç™¼æ”¾å–œé¤…: ${guest.cakeGiven ? 'æ˜¯' : 'å¦'}
å‚™è¨»: ${guest.remarks ? guest.remarks : 'ç„¡'}
å ±åˆ°æ™‚é–“: ${guest.timestamp ? new Date(guest.timestamp).toLocaleString('zh-TW') : 'å°šæœªå ±åˆ°'}
            `;
            alert(details);
        }
    }

    // è·³è½‰åˆ°å ±åˆ°ç•«é¢
    function goToCheckin(serialNumber, guestName, collectMoney, hasCake) {
        // å¾ guestData ä¸­æ‰¾åˆ°è©²è³“å®¢çš„å®Œæ•´è³‡è¨Š
        const guestInfo = guestData.find(guest =>
            String(guest.serialNumber).trim() === String(serialNumber).trim()
        );

        const toBoolean = value => value === true ||
            value === 'true' ||
            value === 'TRUE' ||
            value === 1 ||
            value === '1';

        const params = new URLSearchParams({
            sn: serialNumber,
            name: encodeURIComponent(guestName),
            collectMoney: guestInfo ? toBoolean(guestInfo.collectMoney) : collectMoney,
            hasCake: guestInfo ? toBoolean(guestInfo.hasCake) : hasCake
        });

        const giftAmountValue = guestInfo ? Number(guestInfo.giftAmount || 0) : 0;
        params.set('giftAmount', giftAmountValue);

        const redEnvelopeValue = guestInfo && guestInfo.redEnvelopeNo
            ? String(guestInfo.redEnvelopeNo)
            : '';
        params.set('redEnvelopeNo', redEnvelopeValue);

        const cakeGivenValue = guestInfo ? toBoolean(guestInfo.cakeGiven) : false;
        params.set('cakeGiven', cakeGivenValue);

        const remarksValue = guestInfo ? encodeURIComponent(guestInfo.remarks || '') : '';
        params.set('remarks', remarksValue);

        // å¦‚æœæœ‰å®¶åº­ç·¨è™Ÿï¼ŒåŠ å…¥å®¶åº­æˆå“¡è³‡è¨Š
        if (guestInfo && guestInfo.familyId) {
            // æ‰¾åˆ°åŒå®¶åº­çš„æ‰€æœ‰æˆå“¡
            const familyMembers = guestData.filter(guest => guest.familyId === guestInfo.familyId);

            if (familyMembers.length > 1) {
                // å°‡å®¶åº­æˆå“¡è³‡è¨Šç·¨ç¢¼ç‚º JSON å­—ä¸²
                const familyData = familyMembers.map(member => ({
                    memberName: member.guestName,
                    isCheckedIn: member.checkedIn
                }));

                params.set('familyId', guestInfo.familyId);
                params.set('familyMembers', encodeURIComponent(JSON.stringify(familyData)));

            } else {
            }
        } else {
        }

        // è·³è½‰åˆ°å ±åˆ°ç•«é¢
        window.location.href = `checkin.html?${params.toString()}`;
    }

    // ğŸ”„ æ™ºèƒ½åˆ·æ–°è³‡æ–™
    function refreshData(forceReload = false) {
        if (forceReload) {
            document.getElementById('guest-table-body').innerHTML = `
                <tr id="loading-row">
                    <td colspan="5" class="table-cell text-center py-8">
                        <span class="material-symbols-outlined animate-spin text-2xl text-[var(--primary-color)]">refresh</span>
                        <div class="mt-2 text-gray-500">é‡æ–°è¼‰å…¥è³‡æ–™ä¸­...</div>
                    </td>
                </tr>
            `;
            loadGuestData();
        } else {
            // ä½¿ç”¨æ™ºèƒ½è¼‰å…¥
            smartLoadGuestData();
        }
    }

    // æœç´¢åŠŸèƒ½ï¼ˆæœ¬åœ°æœå°‹ + å‰ç«¯åˆ†é ï¼‰
    function filterGuests(searchTerm) {
        currentSearchTerm = searchTerm.trim();

        if (currentSearchTerm === '') {
            // æ²’æœ‰æœå°‹æ¢ä»¶ï¼Œé¡¯ç¤ºå…¨éƒ¨è³‡æ–™
            filteredData = [...guestData];
        } else {
            // æœ‰æœå°‹æ¢ä»¶ï¼Œéæ¿¾è³‡æ–™
            const searchLower = currentSearchTerm.toLowerCase();
            filteredData = guestData.filter(guest => {
                const matchesSerial = guest.serialNumber.toString().toLowerCase().includes(searchLower);
                const matchesName = guest.guestName.toString().toLowerCase().includes(searchLower);
                return matchesSerial || matchesName;
            });
        }

        // é‡ç½®åˆ°ç¬¬ä¸€é 
        currentPage = 1;

        // æ›´æ–°é¡¯ç¤º
        updatePaginationDisplay();
        renderGuestTable();

        // é¡¯ç¤º/éš±è—æ¸…é™¤æŒ‰éˆ•
        const clearButton = document.getElementById('clear-search');
        if (currentSearchTerm) {
            clearButton.classList.remove('hidden');
        } else {
            clearButton.classList.add('hidden');
        }
    }

    // æ¸…é™¤æœç´¢
    function clearSearch() {
        const searchInput = document.getElementById('search-input');
        searchInput.value = '';
        filterGuests('');
    }

    // æ·»åŠ åˆ·æ–°æŒ‰éˆ•åŠŸèƒ½
    document.addEventListener('DOMContentLoaded', function() {
        // æœç´¢åŠŸèƒ½äº‹ä»¶ç¶å®š
        const searchInput = document.getElementById('search-input');
        const clearButton = document.getElementById('clear-search');

        // å³æ™‚æœç´¢
        searchInput.addEventListener('input', function(e) {
            filterGuests(e.target.value);
        });

        // æ¸…é™¤æœç´¢
        clearButton.addEventListener('click', clearSearch);

        // Enter éµæœç´¢
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                filterGuests(e.target.value);
            }
        });

        // åˆ·æ–°æŒ‰éˆ•åŠŸèƒ½
        function addRefreshButton() {
            const actionsContainer = document.getElementById('guestlist-actions');
            if (!actionsContainer) {
                console.error('æ‰¾ä¸åˆ°é é¢æ¨™é¡Œå€åŸŸï¼Œç„¡æ³•æ·»åŠ åˆ·æ–°æŒ‰éˆ•');
                return;
            }

            // é˜²æ­¢é‡è¤‡æ·»åŠ 
            const existingButton = actionsContainer.querySelector('.refresh-button');
            if (existingButton) {
                return;
            }

            // å‰µå»ºåˆ·æ–°æŒ‰éˆ•
            const refreshButton = document.createElement('button');
            refreshButton.className = 'btn-primary ml-4 refresh-button';
            refreshButton.innerHTML = '<span class="material-symbols-outlined">refresh</span> åˆ·æ–°è³‡æ–™';
            refreshButton.onclick = () => refreshData(true);

            actionsContainer.appendChild(refreshButton);
        }

        // æ·»åŠ åˆ·æ–°æŒ‰éˆ•
        addRefreshButton();

        // åˆ†é æŒ‰éˆ•äº‹ä»¶
        document.getElementById('prev-page')?.addEventListener('click', function() {
            if (currentPage > 1) {
                goToPage(currentPage - 1);
            }
        });

        document.getElementById('next-page')?.addEventListener('click', function() {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            if (currentPage < totalPages) {
                goToPage(currentPage + 1);
            }
        });

        // ğŸš€ æ™ºèƒ½è¼‰å…¥ - æª¢æŸ¥æ˜¯å¦å¾å ±åˆ°ç•«é¢å›è·³
        const urlParams = new URLSearchParams(window.location.search);
        const isLocalUpdate = urlParams.get('localUpdate') === 'true';

        if (isLocalUpdate) {
            // å¾ URL åƒæ•¸è§£æå ±åˆ°è³‡è¨Š
            const remarksParam = urlParams.get('remarks');
            const checkInData = {
                serialNumber: urlParams.get('sn'),
                guestName: decodeURIComponent(urlParams.get('name') || ''),
                collectMoney: urlParams.get('collectMoney') === 'true',
                giftAmount: parseInt(urlParams.get('giftAmount') || '0'),
                redEnvelopeNo: decodeURIComponent(urlParams.get('redEnvelopeNo') || ''),
                hasCake: urlParams.get('hasCake') === 'true',
                cakeGiven: urlParams.get('cakeGiven') === 'true',
                remarks: remarksParam ? decodeURIComponent(remarksParam) : ''
            };

            // ğŸ¯ Linus: é›™è»Œç­–ç•¥ - cache å¿«é€Ÿé¡¯ç¤º + èƒŒæ™¯å¼·åˆ¶é‡è¼‰
            // 1. å…ˆå˜—è©¦å¾ cache å¿«é€Ÿé¡¯ç¤º
            if (guestData.length === 0) {
                loadCacheFromStorage();
            }

            if (guestData.length > 0) {
                console.log('ğŸ“¦ ä½¿ç”¨å¿«å–å¿«é€Ÿé¡¯ç¤ºï¼ŒèƒŒæ™¯åŒæ­¥æœ€æ–°è³‡æ–™...');
                const guest = guestData.find(g => g.serialNumber === parseInt(checkInData.serialNumber));
                if (guest) {
                    checkInData.familyId = guest.familyId;
                    updateLocalGuestData(checkInData);
                }

                // 2. èƒŒæ™¯å¼·åˆ¶é‡è¼‰å®Œæ•´è³‡æ–™
                setTimeout(() => {
                    console.log('ğŸ”„ èƒŒæ™¯é‡æ–°è¼‰å…¥å®Œæ•´è³‡æ–™...');
                    loadGuestData();
                }, 100);
            } else {
                // æ²’æœ‰ cacheï¼Œç›´æ¥è¼‰å…¥
                console.log('ğŸ”„ ç„¡å¿«å–ï¼Œç›´æ¥è¼‰å…¥å®Œæ•´è³‡æ–™...');
                const originalCallback = window.handleGuestData;

                window.handleGuestData = function(response) {
                    originalCallback(response);

                    if (guestData.length > 0) {
                        const guest = guestData.find(g => g.serialNumber === parseInt(checkInData.serialNumber));
                        if (guest) {
                            checkInData.familyId = guest.familyId;
                            updateLocalGuestData(checkInData);
                        }
                    }

                    window.handleGuestData = originalCallback;
                };

                loadGuestData();
            }

            // æ¸…ç† URL åƒæ•¸
            window.history.replaceState({}, document.title, window.location.pathname);
        } else if (urlParams.has('refresh')) {
            // èˆŠç‰ˆæœ¬ç›¸å®¹æ€§ï¼šå¼·åˆ¶åˆ·æ–°
            console.log('ğŸ”„ å¼·åˆ¶åˆ·æ–°æ¨¡å¼');
            loadGuestData();
            window.history.replaceState({}, document.title, window.location.pathname);
        } else {
            // æ­£å¸¸æ™ºèƒ½è¼‰å…¥
            smartLoadGuestData();
        }

        // ğŸ• é™ä½è‡ªå‹•åˆ·æ–°é »ç‡ï¼šæ¯5åˆ†é˜æ™ºèƒ½åˆ·æ–°
        setInterval(() => smartLoadGuestData(true), 5 * 60 * 1000);
    });
</script>

</body></html>
